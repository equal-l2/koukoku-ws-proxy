<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Koukoku Viewer</title>
  </head>

  <body>
    <textarea id="msg-view" readonly></textarea>
    <input id="msg-input" type="text" />
    <button type="button" id="send-button" disabled>Submit</button>
    <button type="button" id="connect-button" disabled>Connect</button>
    <!-- TODO: 演説を別枠で表示する -->

    <script lang="js">
      /** @type HTMLTextAreaElement */
      const msgView = document.getElementById("msg-view")
      /** @type HTMLInputElement */
      const msgInput = document.getElementById("msg-input")

      /** @type HTMLButtonElement */
      const sendButton = document.getElementById("send-button")

      /** @type HTMLButtonElement */
      const connectButton = document.getElementById("connect-button")

      msgView.textContent = ""

      function connect() {
        const sock = new WebSocket("ws://localhost:8080/ws")
        sock.onopen = () => {
            console.log("WS connected")
            function recv(ev) {
              // assume the message is in text type
              msgView.textContent += ev.data + "\n";
              msgView.scrollTop = msgView.scrollHeight
            }
            sock.onmessage = recv

            function send() {
              console.log("send")
              sock.send(msgInput.value + "\n")
            }
            sendButton.onclick = send

            sendButton.disabled = false;
            connectButton.disabled = true;
        }

        sock.onclose = () => {
          console.log("WS disconnected")
          alert("WebSocketが切断されました");
          sendButton.disabled = true;
          connectButton.disabled = false;
        }
      }
      connect()

      connectButton.onclick = connect
    </script>
    <style>
      #msg-view {
        padding: auto;
        width: 90%;
        height: 80vh;
      }
    </style>
  </body>
</html>
